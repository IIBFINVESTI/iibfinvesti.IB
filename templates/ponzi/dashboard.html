{% extends "ponzi/base.html" %}

{% block title %}IIBF TERMINAL - Private Banking{% endblock %}

{% block content %}
<style>
    :root {
        --bank-blue: #0f172a;
        --bank-gold: #c5a059;
        --admin-blue: #00d4ff; 
        --primary-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        --gold-glow: rgba(197, 160, 89, 0.5);
        --neon-green: #10b981;
    }

    body {
        background-color: #060912;
        color: #ffffff;
        font-family: 'Inter', sans-serif;
        background: radial-gradient(circle at 0% 0%, rgba(0, 212, 255, 0.08), transparent 40%),
                    radial-gradient(circle at 100% 100%, rgba(197, 160, 89, 0.1), transparent 40%),
                    #060912;
        min-height: 100vh;
        user-select: none;
    }

    .app-container { max-width: 500px; margin: 0 auto; padding-bottom: 110px; }

    .ticker-wrap {
        width: 100%;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.8);
        border-bottom: 2px solid var(--bank-gold);
        white-space: nowrap;
        padding: 14px 0;
    }

    .ticker {
        display: inline-block;
        animation: ticker 55s linear infinite;
    }

    .ticker-item {
        display: inline-block;
        padding: 0 50px;
        font-size: 0.9rem;
        color: #fff;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        text-shadow: 1px 1px 3px rgba(0,0,0,1);
    }

    @keyframes ticker {
        0% { transform: translateX(100%); }
        100% { transform: translateX(-100%); }
    }

    .text-wao {
        font-weight: 900 !important;
        text-shadow: 2px 2px 12px rgba(0, 0, 0, 1);
        -webkit-font-smoothing: antialiased;
    }

    .investment-price {
        font-size: 1.5rem !important;
        font-weight: 900;
        color: #ffffff;
        letter-spacing: 1px;
    }

    .diamond-blue {
        width: 28px;
        height: 28px;
        fill: var(--admin-blue);
        filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.6));
    }

    .glass-card {
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(197, 160, 89, 0.2);
        border-radius: 20px;
    }

    .card-wallet {
        border: 1px solid var(--bank-gold);
        border-radius: 28px;
        background: var(--primary-gradient);
        position: relative;
        overflow: hidden;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
    }

    .btn-activate {
        background: linear-gradient(90deg, #c5a059, #f1d299);
        color: #000 !important;
        font-weight: 900;
        border-radius: 50px;
        border: none;
        text-transform: uppercase;
        box-shadow: 0 5px 15px var(--gold-glow);
    }

    .active-market-card {
        background: rgba(16, 185, 129, 0.05);
        border: 1px solid rgba(16, 185, 129, 0.3) !important;
        border-left: 4px solid var(--neon-green) !important;
    }

    .progress-container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        height: 6px;
        width: 100%;
        margin-top: 12px;
        overflow: hidden;
        border: 1px solid rgba(16, 185, 129, 0.1);
    }

    .progress-bar-neon {
        height: 100%;
        background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
        box-shadow: 0 0 8px var(--neon-green);
        transition: width 2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .bottom-nav {
        position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
        width: 92%; max-width: 460px; height: 75px;
        background: rgba(15, 23, 42, 0.98); border: 1px solid rgba(197, 160, 89, 0.4);
        border-radius: 25px; display: flex; justify-content: space-around; align-items: center; z-index: 1000;
    }

    .nav-item { color: #ffffff; text-decoration: none; font-size: 0.7rem; font-weight: 800; text-align: center; opacity: 0.7; }
    .nav-item.active { color: var(--bank-gold); opacity: 1; }
    .blink { animation: blinker 1.5s linear infinite; }
    @keyframes blinker { 50% { opacity: 0; } }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="ticker-wrap">
    <div id="dynamic-ticker" class="ticker"></div>
</div>

<div class="app-container px-3">
    
    <div class="d-flex justify-content-between align-items-center pt-4 mb-4">
        <div>
            <h6 class="text-warning fw-bold mb-0 small" style="letter-spacing: 2px;">IIBF TERMINAL</h6>
            <h3 class="text-wao mb-0 text-white">{{ user.username }} <i class="bi bi-patch-check-fill text-primary ms-1"></i></h3>
        </div>
        <div class="glass-card p-2 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; border: 1px solid var(--bank-gold) !important;">
            <i class="bi bi-cpu-fill text-warning fs-4"></i>
        </div>
    </div>

    {% if messages %}
    <div class="mb-3">
        {% for message in messages %}
        <div class="glass-card p-3 border-start border-4 border-warning mb-2" style="background: rgba(0,0,0,0.4);">
            <div class="d-flex align-items-center">
                <i class="bi bi-shield-check-fill text-warning me-2 fs-5"></i>
                <span class="small fw-bold text-white">{{ message }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="glass-card p-2 text-center mb-4 border-warning" style="background: rgba(197, 160, 89, 0.15); border: 1px solid rgba(197, 160, 89, 0.4) !important;">
        <small class="text-warning fw-900 text-uppercase" style="font-size: 0.65rem; letter-spacing: 1px;">Prochaine Injection de Gains (20:00)</small>
        <div id="countdown" class="text-wao fs-4 text-white">00:00:00</div>
    </div>

    <div class="card-wallet p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="text-white-50 fw-bold small">LIQUIDIT√â CERTIFI√âE</span>
            <span class="badge bg-success text-white fw-bold shadow-sm px-3" style="font-size: 0.6rem;">SECURED</span>
        </div>
        <h1 class="text-wao mb-4 text-white" style="font-size: 3.2rem;">
            <span id="votre-solde">0</span> <span class="fs-4 text-warning">XAF</span>
        </h1>
        
        <div class="row g-2">
            <div class="col-6">
                <a href="https://wa.me/237687391981?text=D√©p√¥t%20ID:{{user.id}}" class="btn btn-light w-100 py-3 fw-900 rounded-4 shadow">D√âP√îT</a>
            </div>
            <div class="col-6">
                {% if peut_retirer %}
                    <a href="{% url 'demander_retrait' %}" class="btn btn-activate w-100 py-3 shadow">RETRAIT</a>
                {% else %}
                    <button class="btn btn-outline-light w-100 py-3 opacity-75 fw-900" style="font-size: 0.7rem;" onclick="alert('Retrait disponible Samedi √† 18h')">SAM. 18H</button>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="mb-4">
        <h6 class="text-white-50 fw-900 small mb-3 text-uppercase">Terminal de March√© IA (Live)</h6>
        <div class="glass-card p-3" style="background: #000; border: 1px solid rgba(16, 185, 129, 0.4);">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge bg-danger blink" style="font-size: 0.6rem;">‚óè MARCH√â ACTIF</span>
                <span class="text-success small fw-bold" style="font-size: 0.6rem;">HFT_SERVER_#042</span>
            </div>
            <div style="height: 110px; position: relative;">
                <canvas id="tradingChart"></canvas>
            </div>
            <hr style="border-color: rgba(255,255,255,0.1);">
            <div class="row text-center mt-3">
                <div class="col-6 border-end border-white border-opacity-10">
                    <small class="text-white-50 d-block mb-1" style="font-size: 0.55rem;">PROFIT ESTIM√â</small>
                    <span id="live-profit" class="text-success fw-900">+0.00</span> <small class="text-success" style="font-size: 0.6rem;">XAF</small>
                </div>
                <div class="col-6">
                    <small class="text-white-50 d-block mb-1" style="font-size: 0.55rem;">VOLATILIT√â</small>
                    <span id="live-vol" class="text-warning fw-900">0.84%</span>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-4">
        <h6 class="text-white-50 fw-900 small mb-3 text-uppercase">Mes March√©s Actifs</h6>
        {% for inv in mes_investissements %}
        <div class="glass-card p-3 mb-2 active-market-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="d-flex align-items-center mb-1">
                        <div class="spinner-grow spinner-grow-sm text-success me-2" style="width: 8px; height: 8px;"></div>
                        <span class="text-success fw-bold small" style="font-size: 0.6rem;">TRADING ACTIF</span>
                    </div>
                    <h6 class="fw-bold mb-0 text-white">{{ inv.grille.nom }}</h6>
                </div>
                <div class="text-end">
                    <div class="text-success fw-900">+{{ inv.grille.pourcentage_gain }}%</div>
                    <div class="text-white-50" style="font-size: 0.6rem;">{{ inv.progression_pourcentage }}% COMPL√âT√â</div>
                </div>
            </div>
            <div class="progress-container">
                <div class="progress-bar-neon" style="width: {{ inv.progression_pourcentage }}%;"></div>
            </div>
        </div>
        {% empty %}
        <div class="glass-card p-3 text-center opacity-50">
            <small class="text-white-50">AUCUN MARCH√â ACTIF</small>
        </div>
        {% endfor %}
    </div>

    <div class="glass-card p-3 mb-4">
        <label class="text-warning fw-900 small mb-2 d-block">ID D'AFFILIATION TERMINAL</label>
        <div class="input-group">
            <input type="text" class="form-control bg-transparent border-0 text-white fw-bold small" id="refLink" 
                   value="http://{{ request.get_host }}{% url 'inscription' %}?ref={{ profil.code_parrainage }}" readonly>
            <button class="btn btn-activate btn-sm px-3 rounded-3" onclick="copyRef()">COPIER</button>
        </div>
    </div>

    <div class="mb-4">
        <h6 class="text-white-50 fw-900 small mb-3 text-uppercase">Flux de Tr√©sorerie</h6>
        <div class="glass-card overflow-hidden">
            {% if derniers_gains %}
                {% for gain in derniers_gains %}
                <div class="d-flex align-items-center p-3 border-bottom border-white border-opacity-10">
                    <i class="bi bi-arrow-down-left-circle text-success fs-4 me-3"></i>
                    <div class="flex-grow-1">
                        <div class="text-white fw-bold small">Cr√©dit Dividende</div>
                        <div class="text-white-50 small" style="font-size: 0.6rem;">{{ gain.date_distribution|date:"d M, H:i" }}</div>
                    </div>
                    <div class="text-success fw-900 text-wao">+{{ gain.montant }}</div>
                </div>
                {% endfor %}
            {% else %}
                <div class="p-5 text-center">
                    <p class="text-white fw-bold mb-0">EN ATTENTE DU FLUX</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="mb-5">
        <div class="d-flex align-items-center mb-3">
            <svg class="diamond-blue me-2" viewBox="0 0 24 24">
                <path d="M12 2L4.5 9L12 22L19.5 9L12 2M12 4.4L16.6 9H7.4L12 4.4M12 18.5L8.5 12H15.5L12 18.5Z"/>
            </svg>
            <h6 class="text-white-50 fw-900 small mb-0 text-uppercase">PACKS D'INVESTISSEMENT</h6>
        </div>

        {% for g in grilles %}
        <div class="glass-card p-3 mb-3">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <div class="rounded-4 p-2 me-3" style="background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3);">
                        <svg class="diamond-blue" style="width: 22px; height: 22px;" viewBox="0 0 24 24">
                            <path d="M12 2L4.5 9L12 22L19.5 9L12 2M12 4.4L16.6 9H7.4L12 4.4M12 18.5L8.5 12H15.5L12 18.5Z"/>
                        </svg>
                    </div>
                    <div>
                        <h6 class="fw-bold mb-0 text-white">{{ g.nom }}</h6>
                        <span class="text-success small fw-900">+{{ g.pourcentage_gain }}% / jour</span>
                    </div>
                </div>
                <div class="text-end">
                    <div class="investment-price mb-1">{{ g.montant }} <span style="font-size: 0.7rem; color: var(--bank-gold);">XAF</span></div>
                    {% if profil.solde >= g.montant %}
                    <form action="{% url 'activer_pack' g.id %}" method="POST">
                        {% csrf_token %}
                        <button class="btn btn-activate btn-sm px-4">ACTIVER</button>
                    </form>
                    {% else %}
                    <button class="btn btn-outline-secondary btn-sm px-3 fw-bold opacity-50" disabled>SOLDE</button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

</div>

<nav class="bottom-nav">
    <a href="{% url 'dashboard' %}" class="nav-item active"><i class="bi bi-grid-1x2-fill"></i><br>BANQUE</a>
    <a href="#" class="nav-item"><i class="bi bi-stack"></i><br>MARCH√âS</a>
    <a href="{% url 'demander_retrait' %}" class="nav-item"><i class="bi bi-arrow-left-right"></i><br>RETRAIT</a>
</nav>

<script>
    const names = ["Ahmadou", "In√®s", "Moussa", "Christian", "B√©atrice", "Rodrigue", "Fid√®le", "Sali", "Emile", "Justin", "Marc", "Cynthia"];
    const amounts = [5000, 10000, 25000, 50000, 100000, 15000, 75000];
    const packs = ["SAPHIR", "OR", "DIAMANT", "√âLITE", "G3 TERMINAL"];

    function generateTicker() {
        const ticker = document.getElementById('dynamic-ticker');
        let htmlContent = "";
        for (let i = 0; i < 15; i++) {
            const rName = names[Math.floor(Math.random() * names.length)];
            const rAmount = amounts[Math.floor(Math.random() * amounts.length)];
            const rPack = packs[Math.floor(Math.random() * packs.length)];
            const rID = Math.floor(100 + Math.random() * 899);

            if (i % 3 === 0) {
                htmlContent += `<div class="ticker-item">üí∞ <span style="color: #ffc107;">${rName}</span> VIENT D'ACTIVER LE PACK <span style="color: #ffc107;">${rPack}</span></div>`;
            } else if (i % 3 === 1) {
                htmlContent += `<div class="ticker-item">‚úÖ RETRAIT VALID√â : <span style="color: #10b981;">${rAmount.toLocaleString()} XAF</span> POUR ID_${rID}</div>`;
            } else {
                htmlContent += `<div class="ticker-item">üöÄ D√âP√îT : <span style="color: #00d4ff;">${rAmount.toLocaleString()} XAF</span> RE√áU PAR <span style="color: #00d4ff;">TERMINAL</span></div>`;
            }
        }
        ticker.innerHTML = htmlContent;
    }

    function updateTimer() {
        const now = new Date(); const target = new Date(); target.setHours(20, 0, 0, 0);
        if (now > target) target.setDate(target.getDate() + 1);
        const diff = target - now;
        const h = Math.floor(diff / 1000 / 60 / 60); const m = Math.floor(diff / 1000 / 60) % 60; const s = Math.floor(diff / 1000) % 60;
        document.getElementById('countdown').innerText = (h < 10 ? '0' + h : h) + ":" + (m < 10 ? '0' + m : m) + ":" + (s < 10 ? '0' + s : s);
    }
    setInterval(updateTimer, 1000); updateTimer();

    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        if (!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const value = Math.floor(progress * (end - start) + start);
            obj.innerHTML = value.toLocaleString();
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    function copyRef() {
        var copyText = document.getElementById("refLink"); 
        copyText.select();
        navigator.clipboard.writeText(copyText.value); 
        alert("Lien d'affiliation copi√© !");
    }

    window.addEventListener('load', function() {
        generateTicker();
        const finalSolde = parseFloat("{{ profil.solde }}".replace(',', '.')) || 0;
        animateValue("votre-solde", 0, finalSolde, 1500);

        // --- LOGIQUE DU TERMINAL DE TRADING ---
        const ctx = document.getElementById('tradingChart').getContext('2d');
        let chartData = Array(30).fill(50).map(() => 45 + Math.random() * 20);
        const tradingChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(30).fill(''),
                datasets: [{
                    data: chartData, borderColor: '#10b981', borderWidth: 2, fill: true,
                    backgroundColor: 'rgba(16, 185, 129, 0.1)', pointRadius: 0, tension: 0.4
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { display: false } },
                animation: { duration: 0 }
            }
        });

        let simulatedProfit = 0;
        setInterval(() => {
            const now = new Date();
            if (now.getHours() === 20 && now.getMinutes() < 10) {
                document.getElementById('live-profit').innerText = "INJECTION...";
                return;
            }
            chartData.shift();
            chartData.push(chartData[chartData.length - 1] + (Math.random() - 0.48) * 4);
            tradingChart.update();
            simulatedProfit += Math.random() * 2.5;
            document.getElementById('live-profit').innerText = "+" + simulatedProfit.toFixed(2);
            document.getElementById('live-vol').innerText = (Math.random() * 1.5).toFixed(2) + "%";
        }, 1500);
    });
</script>
{% endblock %}